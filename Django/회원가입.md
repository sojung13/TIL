## Authentication System 2



### â¤ï¸ íšŒì›ê°€ì…

> UserCreationForm

- ì£¼ì–´ì§„ usernameê³¼ passwordë¡œ ê¶Œí•œì´ ì—†ëŠ” ìƒˆ userë¥¼ ìƒì„±í•˜ëŠ” ModelForm
- 3ê°œì˜ í•„ë“œë¥¼ ê°€ì§
  - username(from the user model)
  - password1
  - password2



![image-20220411142130798](íšŒì›ê°€ì….assets/image-20220411142130798.png)

ğŸ‘‰ urls.pyì— path ê²½ë¡œë¥¼ ë§Œë“¤ì–´ì¤€ë‹¤.

```python
# accounts ì•± í´ë” ë‚´ views.py

@require_http_methods(['GET', 'POST'])
def signup(request):
    if request.method == 'POST':
        form = UserCreationForm(request.POST)
        if form.is_valid():
            user = form.save()
            # íšŒì›ê°€ì… í›„ ìë™ìœ¼ë¡œ ë¡œê·¸ì¸ ì§„í–‰í•˜ê¸°
            auth_login(request, user)
            return redirect('accounts:index')
    else:
        form = UserCreationForm()
    context = {
        'form' : form,
    }
    return render(request,'accounts/signup.html', context)
```

![image-20220411142545566](íšŒì›ê°€ì….assets/image-20220411142545566.png)

ğŸ‘‰ ëŒ€ëµì ì¸ êµ¬ì¡°ëŠ” create í•¨ìˆ˜ì™€ ì •ë§ ë¹„ìŠ·í•˜ë‹¤! ì‚¬ìš©í•˜ëŠ” formì´ ë‹¤ë¥´ë‹¤ëŠ”ê±° ì™¸ì—ëŠ” ì°¨ì´ì ì´ ê±°ì˜ ì—†ë‹¤. ê·¸ë¦¬ê³  ìœ„ì™€ ê°™ì´ ì½”ë“œ ì‘ì„± ì‹œ íšŒì›ê°€ì… ì°½ì´ ì‚¬ì§„ê³¼ ê°™ì´ ëœ¬ë‹¤.



----



### ğŸ’› íšŒì›íƒˆí‡´

- íšŒì›íƒˆí‡´ëŠ” DBì—ì„œ ì‚¬ìš©ìë¥¼ ì‚­ì œí•˜ëŠ” ê²ƒê³¼ ê°™ìŒ

![image-20220411144043308](íšŒì›ê°€ì….assets/image-20220411144043308.png)

ğŸ‘‰accounts ë‚´ë¶€ urls.pyì— ê²½ë¡œë¥¼ ì‘ì„±í•œë‹¤.

```python
# accounts ì•± í´ë” ë‚´ views.py

@request_POST
def delete(request):
    if request.user.is_authenticated:
        # ì£¼ì˜ì‚¬í•­! ë¡œê·¸ì•„ì›ƒ ë¨¼ì € í•˜ë©´ íšŒì›íƒˆí‡´ê°€ ì•ˆëœë‹¤.
        # ë¨¼ì € ìœ ì €ë¥¼ ì§€ìš´ ë‹¤ìŒ(íšŒì›íƒˆí‡´ í›„) ë¡œê·¸ì•„ì›ƒ ì‹œì¼œì¤˜ì•¼ í•œë‹¤.
	    request.user.delete()
        auth_logout(request)
    return redirect('accounts:index')
```



----



### ğŸ’š íšŒì›ì •ë³´ ìˆ˜ì •

> UserChangeForm

- ì‚¬ìš©ìì˜ ì •ë³´ ë° ê¶Œí•œì„ ë³€ê²½í•˜ê¸° ìœ„í•´ admin ì¸í„°í˜ì´ìŠ¤ì—ì„œ ì‚¬ìš©ë˜ëŠ” ModelForm

![image-20220411150247829](íšŒì›ê°€ì….assets/image-20220411150247829.png)

ğŸ‘‰accounts ë‚´ë¶€ urls.pyì— ê²½ë¡œë¥¼ ì‘ì„±í•œë‹¤.

```python
# accounts ì•± í´ë” ë‚´ views.py

@login_required
@require_http_methods(['GET', 'POST'])
def update(request):
    if request.method == 'POST':
        form = CustomUserChangeForm(request.POST, instance=request.user)
        if form.is_valid():
            user = form.save()
            return redirect('accounts:index')
    else:
        form = CustomUserChangeForm(instance=request.user)
    context = {
        'form' : form,
    }
    return render(request, 'accounts/update.html', context)
```

ğŸ‘‰ ì—¬ê¸°ê¹Œì§€ ì‘ì„±í•˜ë©´ ìˆ˜ì •ì— ê´€í•œ ì˜¨ê°– ì •ë³´ê°€ HTML ë¬¸ì„œ ë‚´ì— ë‹¤ ëœ¬ë‹¤! (ì¼ë°˜ ì‚¬ìš©ìê°€ ì ‘ê·¼í•´ì„œëŠ” ì•ˆë  ì •ë³´ë“¤(fields)ê¹Œì§€ ëª¨ë‘ ìˆ˜ì •ì´ ê°€ëŠ¥í•´ì§„ë‹¤ëŠ” ëœ»). ê·¸ë˜ì„œ Formì„ ì‘ì„±í•´ì„œ ë³´ì—¬ì¤„ ë¶€ë¶„ë§Œ ë³´ì—¬ì¤„ ê²ƒì´ë‹¤. 

ğŸ‘‰ forms.py ë§Œë“¤ì–´ì£¼ê¸°

```python
# accounts ì•± í´ë” ë‚´ forms.py

from django.contrib.auth.forms import UserChangeForm
from django.contrib.auth import get_user_model

class CustomUserChageForm(UserChangeForm):
    # íšŒì›ì •ë³´ ìˆ˜ì • í˜ì´ì§€ì—ì„œ ë¶ˆí¸í•˜ê²Œ ë””ìì¸ëœ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ë€ ì—†ì• ê³  ì‹¶ë‹¤ë©´ ì‘ì„±í•˜ê¸°
    # í•˜ì§€ë§Œ íŒ¨ìŠ¤ì›Œë“œ ë³€ê²½ì°½ì„ ìƒˆë¡œ ë„ì›Œì•¼í•œë‹¤ëŠ” ë‹¨ì ì´ ìˆë‹¤. ì„ íƒì‚¬í•­ì„.
    password = None
    class Meta:
        model = get_user_model()
        # ë³´ì—¬ì¤„ ë¶€ë¶„ë§Œ ì‘ì„±í•´ì£¼ê¸°
        fields = ('email','first_name','last_name',)
```

![image-20220411151812099](íšŒì›ê°€ì….assets/image-20220411151812099.png)

> get_user_model()

- í˜„ì¬ í”„ë¡œì íŠ¸ì—ì„œ í™œì„±í™”ëœ ì‚¬ìš©ì ëª¨ë¸(active user model)ì„ ë°˜í™˜
- DjangoëŠ” User í´ë˜ìŠ¤ë¥¼ ì§ì ‘ ì°¸ì¡°í•˜ëŠ” ëŒ€ì‹  django.contrib.auth.get_user_model()ì„ ì‚¬ìš©í•˜ì—¬ ì°¸ì¡°í•´ì•¼ í•œë‹¤ê³  ê°•ì¡°



----



### ğŸ’™ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½

> PasswordChangeForm

- ì‚¬ìš©ìê°€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” Form

- ì´ì „ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì—¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•  ìˆ˜ ìˆë„ë¡ í•¨

- ì´ì „ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì´ë²½í•˜ì§€ ì•Šê³  ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆëŠ” SetPasswordFormì„ ìƒì†ë°›ëŠ” ì„œë¸Œ í´ë˜ìŠ¤

![image-20220411153049136](íšŒì›ê°€ì….assets/image-20220411153049136.png)

ğŸ‘‰ accounts ë‚´ë¶€ urls.pyì— ê²½ë¡œë¥¼ ì‘ì„±í•œë‹¤.



```python
# accounts ì•± í´ë” ë‚´ views.py

def change_password(request):
    if request.method == 'POST':
        form = PasswordChangeForm(request.user, request.POST)
        if form.is_valid():
            form.save()
            return redirect('articles:index')
    else:
        form = PasswordChangeForm(request.user)
    context = {
        'form' : form,
    }
    return render(request, 'accounts:change_password.html', context)
```

ğŸ‘‰ì—¬ê¸°ê¹Œì§€ ì‘ì„±í•˜ë©´ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½í•˜ë©° ë¡œê·¸ì•„ì›ƒì´ ë˜ì–´ë²„ë¦°ë‹¤. ì´ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ ì„¸ì…˜ë„ ê°™ì´ ì—…ë°ì´íŠ¸í•´ì£¼ì–´ì•¼ í•œë‹¤.



> ì•”í˜¸ ë³€ê²½ ì‹œ ì„¸ì…˜ ë¬´íš¨í™” ë°©ì§€

- update_session_auth_hash
  - í˜„ì¬ ìš”ì²­ê³¼ ìƒˆ session hashê°€ íŒŒìƒë  ì—…ë°ì´íŠ¸ëœ ì‚¬ìš©ì ê°ì²´ë¥¼ ê°€ì ¸ì˜¤ê³ , session hashë¥¼ ì ì ˆí•˜ê²Œ ì—…ë°ì´íŠ¸
  - ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ë©´ ê¸°ì¡´ ì„¸ì…˜ê³¼ì˜ íšŒì› ì¸ì¦ ì •ë³´ê°€ ì¼ì¹˜í•˜ì§€ ì•Šê²Œ ë˜ì–´ ë¡œê·¸ì¸ ìƒíƒœë¥¼ ìœ ì§€í•  ìˆ˜ ì—†ê¸° ë•Œë¬¸
  - ì•”í˜¸ê°€ ë³€ê²½ë˜ì–´ë„ ë¡œê·¸ì•„ì›ƒë˜ì§€ ì•Šë„ë¡ ìƒˆë¡œìš´ password hashë¡œ sessionì„ ì—…ë°ì´íŠ¸í•¨

```python
# accounts ì•± í´ë” ë‚´ views.py

@login_required
@require_http_methods(['GET', 'POST'])
def change_password(request):
    if request.method == 'POST':
        form = PasswordChangeForm(request.user, request.POST)
        if form.is_valid():
            user = form.save()
            update_session_auth_hash(request, user)
            return redirect('articles:index')
    else:
        form = PasswordChangeForm(request.user)
    context = {
        'form' : form,
    }
    return render(request, 'accounts:change_password.html', context)
```







